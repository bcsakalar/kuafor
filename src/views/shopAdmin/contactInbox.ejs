<%
	function safeText(v, fallback) {
		const s = String(v || '').trim();
		return s ? s : (fallback || '—');
	}

	function formatTRDateTime(value) {
		if (!value) return '—';
		try { return new Date(value).toLocaleString('tr-TR', { timeZone: 'Europe/Istanbul' }); } catch { return '—'; }
	}

	function statusTR(status) {
		const s = String(status || '').trim().toLowerCase();
		if (s === 'new') return 'Yeni';
		if (s === 'read') return 'Okundu';
		if (s === 'archived') return 'Arşiv';
		return safeText(status, '—');
	}

	const q = (typeof query === 'object' && query) ? query : {};
	const statusFilter = String(q.status || 'new').trim().toLowerCase();
	const ok = String(q.ok || '') === '1' || String(q.ok || '').toLowerCase() === 'true' || String(q.ok || '') === 'ok';
	const err = String(q.err || '');
%>

<header class="mb-6 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
	<div>
		<h1 class="text-2xl font-semibold">Gelen Kutusu</h1>
		<p class="mt-1 ui-muted text-sm">Shop iletişim formundan gelen mesajlar.</p>
	</div>
	<div class="flex flex-wrap items-center gap-2">
		<a class="ui-btn ui-btn-secondary" href="/inbox?status=new">Yeniler</a>
		<a class="ui-btn ui-btn-secondary" href="/inbox?status=read">Okunanlar</a>
		<a class="ui-btn ui-btn-secondary" href="/inbox?status=archived">Arşiv</a>
		<a class="ui-btn ui-btn-secondary" href="/inbox?status=all">Tümü</a>
	</div>
</header>

<% if (ok) { %>
	<div class="mb-4 p-3 rounded border border-emerald-200 dark:border-emerald-900 bg-emerald-50 dark:bg-emerald-950/30 text-emerald-800 dark:text-emerald-200 text-sm">İşlem başarılı.</div>
<% } %>

<% if (err) { %>
	<div class="mb-4 p-3 rounded border border-rose-200 dark:border-rose-900 bg-rose-50 dark:bg-rose-950/30 text-rose-800 dark:text-rose-200 text-sm">
		<% if (err === 'notfound') { %>
			Mesaj bulunamadı.
		<% } else { %>
			Bir hata oluştu.
		<% } %>
	</div>
<% } %>

<div class="ui-card ui-border rounded-2xl p-5">
	<div class="flex items-center justify-between gap-3">
		<p class="text-sm ui-muted">Filtre: <span class="font-semibold"><%= statusTR(statusFilter) %></span></p>
		<p class="text-xs ui-muted"><%= (messages || []).length %> mesaj</p>
	</div>

	<div class="mt-4 grid gap-3">
		<% (messages || []).forEach((m) => { %>
			<%
				const st = String(m.status || '').trim().toLowerCase();
				const badgeClass = st === 'new'
					? 'border-emerald-200 dark:border-emerald-900 text-emerald-800 dark:text-emerald-200 bg-emerald-50 dark:bg-emerald-950/30'
					: (st === 'archived'
						? 'border-zinc-200 dark:border-zinc-800 text-zinc-700 dark:text-zinc-200 bg-zinc-50 dark:bg-zinc-950/30'
						: 'border-blue-200 dark:border-blue-900 text-blue-800 dark:text-blue-200 bg-blue-50 dark:bg-blue-950/30');
			%>
			<a href="/inbox/<%= encodeURIComponent(m.id) %>" class="block border ui-border rounded-xl p-4 hover:bg-[color:var(--bg-elevated)]/40 transition">
				<div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
					<div class="min-w-0">
						<p class="font-semibold truncate">
							<%= safeText(m.full_name, 'Müşteri') %>
							<span class="ml-2 text-sm ui-muted font-normal">• <%= safeText(m.email) %></span>
						</p>
						<p class="mt-1 text-sm ui-muted truncate"><%= safeText(m.subject, 'Konu yok') %></p>
						<p class="mt-1 text-xs ui-muted">Gönderim: <%= formatTRDateTime(m.created_at) %></p>
					</div>
					<div class="shrink-0">
						<span class="inline-flex items-center rounded-full border px-2 py-0.5 text-xs <%= badgeClass %>"><%= statusTR(m.status) %></span>
					</div>
				</div>
			</a>
		<% }) %>

		<% if (!messages || messages.length === 0) { %>
			<p class="ui-muted text-sm">Bu filtrede mesaj yok.</p>
		<% } %>
	</div>
</div>
