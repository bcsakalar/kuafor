<header class="mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
	<div>
		<h1 class="text-2xl font-semibold">Shop Admin</h1>
		<p class="mt-1 ui-muted text-sm">Ürün ve sipariş yönetimi.</p>
	</div>
</header>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
	<div class="ui-card ui-border rounded-2xl p-5">
		<p class="ui-muted text-sm">Toplam Ürün</p>
		<p class="mt-1 text-3xl font-semibold"><%= Number(productsCount || 0) %></p>
		<a class="mt-4 inline-flex ui-btn ui-btn-primary" href="/products">Ürünleri Yönet</a>
	</div>
	<div class="ui-card ui-border rounded-2xl p-5">
		<p class="ui-muted text-sm">Bugün</p>
		<p class="mt-1 text-3xl font-semibold"><%= Number((todayStats && todayStats.orders_today) || 0) %></p>
		<p class="mt-1 text-sm ui-muted">Sipariş • <%= Number((todayStats && todayStats.revenue_today) || 0).toFixed(2) %> ₺ ciro</p>
		<div class="mt-3 flex flex-wrap gap-2 text-xs">
			<span class="border ui-border rounded-full px-2 py-1">Sipariş Alındı: <span id="shopPendingOrdersCount"><%= Number((todayStats && todayStats.pending_today) || 0) %></span></span>
			<span class="border ui-border rounded-full px-2 py-1">Kargoya Verildi: <%= Number((todayStats && todayStats.shipped_today) || 0) %></span>
			<span class="border ui-border rounded-full px-2 py-1">Teslim Edildi: <%= Number((todayStats && todayStats.completed_today) || 0) %></span>
			<span class="border ui-border rounded-full px-2 py-1">İptal Edildi: <%= Number((todayStats && todayStats.cancelled_today) || 0) %></span>
		</div>
		<a class="mt-4 inline-flex ui-btn ui-btn-secondary" href="/orders">Siparişler</a>
	</div>
	<div class="ui-card ui-border rounded-2xl p-5">
		<p class="ui-muted text-sm">Bu Ay</p>
		<p class="mt-1 text-3xl font-semibold"><%= Number((monthShopRevenue && monthShopRevenue.shop_revenue_month) || 0).toFixed(2) %> ₺</p>
		<p class="mt-1 text-sm ui-muted">İptal hariç toplam shop cirosu</p>
		<a class="mt-4 inline-flex ui-btn ui-btn-secondary" href="/orders">Sipariş Raporu</a>
	</div>
	<div class="ui-card ui-border rounded-2xl p-5 flex flex-col min-h-0 overflow-hidden">
		<div class="flex items-center justify-between gap-3 flex-shrink-0">
			<h2 class="text-lg font-semibold truncate">Az Kalanlar</h2>
			<a class="ui-btn ui-btn-secondary flex-shrink-0" href="/products">Ürünler</a>
		</div>
		<div class="mt-4 grid gap-2 min-h-0 overflow-y-auto" style="max-height: 280px;">
			<% (lowStockProducts || []).forEach((p) => { %>
				<div class="flex items-center justify-between gap-4 border ui-border rounded-xl p-3 flex-shrink-0">
					<div class="min-w-0 flex-1">
						<p class="font-semibold truncate"><a class="underline hover:no-underline" href="/products/<%= p.id %>"><%= p.name %></a></p>
						<p class="text-xs ui-muted truncate"><%= p.category_name || 'Kategori yok' %></p>
					</div>
					<p class="text-sm font-semibold whitespace-nowrap flex-shrink-0">Stok: <%= p.stock %> / <%= p.low_stock_threshold %></p>
				</div>
			<% }) %>
			<% if (!lowStockProducts || lowStockProducts.length === 0) { %>
				<p class="ui-muted text-sm flex-shrink-0">Az stok uyarısı yok.</p>
			<% } %>
		</div>
	</div>
	<div class="ui-card ui-border rounded-2xl p-5 lg:col-span-3">
		<div class="flex items-center justify-between gap-3">
			<h2 class="text-lg font-semibold">Son 7 Günlük Shop Geliri</h2>
			<a class="ui-btn ui-btn-secondary" href="/orders">Siparişler</a>
		</div>
		<p class="ui-muted mt-1 text-sm">Günlük ciro (iptal hariç).</p>
		<div class="mt-4" style="height: 260px;">
			<canvas id="shopRevenue7dChart"></canvas>
		</div>
	</div>
	<div class="ui-card ui-border rounded-2xl p-5 lg:col-span-3">
		<div class="flex items-center justify-between gap-3">
			<h2 class="text-lg font-semibold">En Çok Satılan 5 Ürün</h2>
			<a class="ui-btn ui-btn-secondary" href="/products">Ürünler</a>
		</div>
		<div class="mt-4 overflow-x-auto">
			<table class="w-full text-sm">
				<thead>
					<tr class="text-left border-b ui-border">
						<th class="py-2">Ürün</th>
						<th class="py-2">Adet</th>
						<th class="py-2">Ciro</th>
					</tr>
				</thead>
				<tbody>
					<% if (!topProducts || topProducts.length === 0) { %>
						<tr class="border-b ui-border">
							<td class="py-3 ui-muted" colspan="3">Henüz satış verisi yok.</td>
						</tr>
					<% } %>
					<% (topProducts || []).forEach((p) => { %>
						<tr class="border-b ui-border">
							<td class="py-2"><%= p.product_name || '-' %></td>
							<td class="py-2"><%= Number(p.sold_quantity || 0) %></td>
							<td class="py-2"><%= Number(p.revenue || 0).toFixed(2) %> ₺</td>
						</tr>
					<% }) %>
				</tbody>
			</table>
		</div>
	</div>
	<div class="ui-card ui-border rounded-2xl p-5 lg:col-span-3">
		<div class="flex items-center justify-between gap-3">
			<h2 class="text-lg font-semibold">Son Siparişler</h2>
			<a class="ui-btn ui-btn-secondary" href="/orders">Tümü</a>
		</div>
		<div class="mt-4 grid gap-3" id="shopAdminRecentOrders">
			<% (orders || []).forEach((o) => { %>
				<%
					const statusLabel = (typeof orderStatusLabelTR === 'function')
						? orderStatusLabelTR(o)
						: ((typeof orderStageLabelTR === 'function')
							? orderStageLabelTR(o.status)
							: (o.status === 'pending'
								? 'Sipariş Alındı'
								: (o.status === 'shipped'
									? 'Kargoya Verildi'
									: (o.status === 'completed'
										? 'Teslim Edildi'
										: (o.status === 'cancelled' ? 'İptal Edildi' : String(o.status || ''))))));
				%>
				<div class="flex items-center justify-between gap-4 border ui-border rounded-xl p-3">
					<div>
						<p class="font-semibold"><a class="underline" href="/orders/<%= o.id %>">#<%= o.id %></a></p>
						<p class="text-sm ui-muted"><span class="border ui-border rounded-full px-2 py-0.5 text-xs"><%= statusLabel %></span> • <%= (o.items_count || 0) %> ürün • <%= new Date(o.created_at).toLocaleString('tr-TR', { timeZone: 'Europe/Istanbul' }) %></p>
						<% if (o.customer_full_name || o.customer_phone || o.customer_email) { %>
							<p class="mt-1 text-xs ui-muted">
								<%= o.customer_full_name || 'Müşteri' %>
								<% if (o.customer_phone) { %> • <%= o.customer_phone %><% } %>
								<% if (o.customer_email) { %> • <%= o.customer_email %><% } %>
							</p>
						<% } %>
					</div>
					<p class="font-semibold"><%= Number(o.total_amount).toFixed(2) %> ₺</p>
				</div>
			<% }) %>
			<% if (!orders || orders.length === 0) { %>
				<p class="ui-muted text-sm">Henüz sipariş yok.</p>
			<% } %>
		</div>
	</div>
</div>

<script type="application/json" id="shopAdminDashboardData"><%- JSON.stringify({ last7DaysShopRevenue: (last7DaysShopRevenue || []) }).replace(/</g, '\\u003c') %></script>

<script>
	(function () {
		try {
			const el = document.getElementById('shopAdminDashboardData');
			const raw = el ? (el.textContent || el.innerText || '') : '';
			window.__SHOPADMIN_DASHBOARD__ = raw ? JSON.parse(raw) : { last7DaysShopRevenue: [] };
		} catch {
			window.__SHOPADMIN_DASHBOARD__ = { last7DaysShopRevenue: [] };
		}
	})();
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
<script src="/public/js/shopAdmin/dashboard.js" defer></script>
