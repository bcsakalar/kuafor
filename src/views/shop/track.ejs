<section class="max-w-5xl mx-auto px-4 sm:px-6 py-10">
	<div class="ui-card ui-border rounded-2xl p-6 sm:p-8">
		<div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-4">
			<div>
				<p class="text-xs ui-muted tracking-widest uppercase">Sipariş Takibi</p>
				<h1 class="mt-2 text-2xl sm:text-3xl font-semibold">Siparişini takip et</h1>
				<p class="mt-2 ui-muted">Takip kodunu (veya sipariş numaranı) girerek sipariş durumunu ve geçmişini görüntüleyebilirsin.</p>
			</div>
			<a href="/" class="ui-btn ui-btn-secondary">Mağazaya Dön</a>
		</div>

		<form class="mt-6 flex flex-col sm:flex-row gap-2" method="get" action="/track">
			<input
				name="code"
				value="<%= code || '' %>"
				data-track-input
				class="flex-1 border ui-border bg-[color:var(--bg-elevated)] rounded px-3 py-2"
				placeholder="Örn: TRK-AB12-CD34-EF56"
				autocomplete="off"
			/>
			<button class="ui-btn ui-btn-primary" type="submit">Sorgula</button>
		</form>

		<% if (error) { %>
			<div class="mt-4 p-3 rounded border border-red-200 dark:border-red-900 bg-red-50 dark:bg-red-950/30 text-red-800 dark:text-red-200 text-sm"><%= error %></div>
		<% } %>

		<% if (order) { %>
			<div class="mt-6 grid grid-cols-1 lg:grid-cols-5 gap-6">
				<div class="lg:col-span-3 ui-card ui-border rounded-2xl p-6">
					<div class="flex items-start justify-between gap-4">
						<div>
							<h2 class="text-lg font-semibold">Sipariş Özeti</h2>
							<div class="mt-1 flex flex-wrap items-center gap-2 text-sm ui-muted">
								<span>Takip Kodu:</span>
								<span class="font-mono"><%= order.tracking_code %></span>
								<button class="ui-btn ui-btn-secondary px-3 py-1.5 text-xs" type="button" data-copy-value="<%= order.tracking_code %>">Kopyala</button>
							</div>
						</div>
						<div class="text-right">
							<p class="text-sm ui-muted">Durum</p>
							<p class="mt-1 inline-flex items-center border ui-border rounded-full px-2 py-0.5 text-xs font-semibold" data-order-status data-order-id="<%= order.id %>">
								<%= (typeof orderStatusLabelTR === 'function' ? orderStatusLabelTR(order) : statusLabelTR(order.status)) %>
							</p>
							<div class="mt-2 flex flex-wrap justify-end gap-2">
								<span class="inline-flex items-center border ui-border rounded-full px-2 py-0.5 text-xs font-semibold ui-muted">
									Ödeme: <%= (typeof paymentStatusLabelTR === 'function' ? paymentStatusLabelTR(order.payment_status) : String(order.payment_status || 'pending')) %>
								</span>
								<%
									const psNow = String(order.payment_status || '').toLowerCase();
									const hasCancelReq = !!(cancellationRequest && cancellationRequest.status && psNow !== 'refunded');
									const crs = hasCancelReq ? String(cancellationRequest.status || '').toLowerCase() : '';
									const crLabel = hasCancelReq
										? (() => {
											const s = String(cancellationRequest.status || '').toLowerCase();
											if (s === 'approved') return 'İade Talebi Onaylandı';
											if (s === 'rejected') return 'İade Talebi Reddedildi';
											if (s === 'cancelled') return 'İade Talebi İptal';
											return 'İade Talebi Alındı';
										})()
										: 'İade Talebi';
									const crCls = crs === 'rejected' || crs === 'cancelled' ? 'ui-muted' : 'ui-accent';
								%>
								<% if (hasCancelReq) { %>
								<span
									class="inline-flex items-center border ui-border rounded-full px-2 py-0.5 text-xs font-semibold <%= crCls %>"
									data-rt-cancel-badge
									data-order-id="<%= order.id %>"
									data-rt-cancel-status="<%= String(cancellationRequest.status) %>"
								><%= crLabel %></span>
								<% } %>
							</div>
						</div>
					</div>

					<%
						const os = String(order.status || '').toLowerCase();
						const ps = String(order.payment_status || '').toLowerCase();
						const canRequestCancel = os === 'pending' && (ps === 'paid' || ps === 'partial_refunded');
						const cannotCancelBecauseShipped = os === 'shipped' || os === 'completed';
					%>
					<% if (ps === 'refunded') { %>
						<div class="mt-4 border ui-border rounded-xl p-4 bg-[color:var(--bg-elevated)]">
							<p class="font-semibold">İade işlemi tamamlandı</p>
							<p class="mt-1 text-sm ui-muted">
								Bu siparişin ödemesi <strong>iade edildi</strong>.
								<% if (order.refunded_at) { %> • Tarih: <%= new Date(order.refunded_at).toLocaleString('tr-TR', { timeZone: 'Europe/Istanbul' }) %><% } %>
								<% if (order.refunded_amount != null) { %> • İade: <%= Number(order.refunded_amount || 0).toFixed(2) %> ₺<% } %>
							</p>
						</div>
					<% } else if (cannotCancelBecauseShipped) { %>
						<div class="mt-4 border ui-border rounded-xl p-4 bg-[color:var(--bg-elevated)]">
							<p class="font-semibold">İptal edilemez</p>
							<p class="mt-1 text-sm ui-muted">
								Bu sipariş <strong><%= (typeof orderStageLabelTR === 'function' ? orderStageLabelTR(order.status) : statusLabelTR(order.status)) %></strong> aşamasında olduğu için iptal edilemez.
								İade/iptal koşulları için <a class="underline" href="/sozlesmeler/iptal-iade">İptal ve İade Koşulları</a> sayfasını inceleyebilirsin.
							</p>
						</div>
					<% } else if (canRequestCancel && (!cancellationRequest || String(cancellationRequest.status) !== 'requested')) { %>
									<div class="mt-4 border ui-border rounded-xl p-4 bg-[color:var(--bg-elevated)]">
										<p class="font-semibold">İade talebi</p>
							<p class="mt-1 text-sm ui-muted">
											Ödeme alınmış siparişler için iade işlemi talep olarak alınır. Siparişiniz kargoya verilmediyse onay sonrası iade işlemi yapılır.
											İade talebi oluşturmak için “Siparişlerim” sayfasından ilgili siparişi seçebilirsin.
							</p>
							<a class="mt-3 ui-btn ui-btn-secondary" href="/orders">Siparişlerime Git</a>
						</div>
					<% } else if (cancellationRequest && String(cancellationRequest.status) === 'requested') { %>
						<div class="mt-4 border ui-border rounded-xl p-4 bg-[color:var(--bg-elevated)]">
										<p class="font-semibold">İade talebin işleme alındı</p>
							<p class="mt-1 text-sm ui-muted">
								Talep zamanı: <%= cancellationRequest.created_at ? new Date(cancellationRequest.created_at).toLocaleString('tr-TR', { timeZone: 'Europe/Istanbul' }) : '—' %>
								• Sipariş kargoya verilmediyse, onay sonrası iade işlemi başlatılır.
							</p>
						</div>
					<% } else if (cancellationRequest && String(cancellationRequest.status) === 'rejected') { %>
						<div class="mt-4 border ui-border rounded-xl p-4 bg-[color:var(--bg-elevated)]">
									<p class="font-semibold">İade talebin reddedildi</p>
							<p class="mt-1 text-sm ui-muted">
								Yanıt zamanı: <%= cancellationRequest.processed_at ? new Date(cancellationRequest.processed_at).toLocaleString('tr-TR', { timeZone: 'Europe/Istanbul' }) : '—' %>
								<% if (cancellationRequest.admin_note) { %>
									<br />Not: <%= String(cancellationRequest.admin_note) %>
								<% } %>
							</p>
						</div>
					<% } else if (cancellationRequest && String(cancellationRequest.status) === 'approved') { %>
						<div class="mt-4 border ui-border rounded-xl p-4 bg-[color:var(--bg-elevated)]">
									<p class="font-semibold">İade talebin onaylandı</p>
							<p class="mt-1 text-sm ui-muted">
								Yanıt zamanı: <%= cancellationRequest.processed_at ? new Date(cancellationRequest.processed_at).toLocaleString('tr-TR', { timeZone: 'Europe/Istanbul' }) : '—' %>
								• Sipariş iptal edildi ve uygunsa iade işlemi başlatıldı. Bankanıza bağlı olarak iade birkaç iş günü sürebilir.
								<% if (cancellationRequest.admin_note) { %>
									<br />Not: <%= String(cancellationRequest.admin_note) %>
								<% } %>
							</p>
						</div>
					<% } %>

					<div class="mt-4 grid gap-2 text-sm">
						<p class="ui-muted">Sipariş Tarihi</p>
						<p><%= new Date(order.created_at).toLocaleString('tr-TR', { timeZone: 'Europe/Istanbul' }) %></p>
					</div>

					<div class="mt-4 grid gap-2 text-sm">
						<p class="ui-muted">Teslimat Adresi</p>
						<p class="whitespace-pre-line break-words"><%= order.shipping_address %></p>
					</div>

					<div class="mt-6">
						<h3 class="text-sm font-semibold">Ürünler</h3>
						<div class="mt-3 grid gap-3">
							<% (order.items || []).forEach((it) => { %>
								<div class="order-item-row">
									<div class="order-item-info min-w-0">
										<p class="font-semibold truncate"><%= it.product_name || 'Ürün' %></p>
										<p class="text-sm ui-muted">
											Adet: <%= it.quantity %> • <span class="order-item-unit"><%= Number(it.price_at_purchase).toFixed(2) %>&nbsp;₺</span>
											<% if (it.selected_size) { %> • Boyut: <%= it.selected_size %><% } %>
											<% if (it.selected_color) { %> • Renk: <%= it.selected_color %><% } %>
										</p>
									</div>
									<p class="order-item-total font-semibold"><%= (Number(it.price_at_purchase) * Number(it.quantity)).toFixed(2) %>&nbsp;₺</p>
								</div>
							<% }) %>
						</div>
						<div class="mt-6 pt-4 border-t ui-border flex items-center justify-between">
							<p class="ui-muted">Toplam</p>
							<p class="text-lg font-semibold whitespace-nowrap"><%= Number(order.total_amount || 0).toFixed(2) %>&nbsp;₺</p>
						</div>
					</div>
				</div>

				<div class="lg:col-span-2 ui-card ui-border rounded-2xl p-6">
					<h2 class="text-lg font-semibold">Durum Geçmişi</h2>
					<p class="mt-2 ui-muted text-sm">Sipariş ve ödeme durumundaki değişiklikler burada görünür.</p>
					<%
						const paymentEvents = Array.isArray(order.paymentEvents) ? order.paymentEvents : [];
						const hasPaymentEvents = paymentEvents.length > 0;
						const hasOrderEvents = Array.isArray(order.events) && order.events.length > 0;
					%>

					<div class="mt-5">
						<h3 class="text-sm font-semibold">Ödeme Geçmişi</h3>
						<div class="mt-3 grid gap-3">
							<% if (hasPaymentEvents) { %>
								<% paymentEvents.forEach((ev) => { %>
									<div class="border ui-border rounded-xl p-3">
										<p class="font-semibold"><%= (typeof paymentStatusLabelTR === 'function' ? paymentStatusLabelTR(ev.status) : String(ev.status || '')) %></p>
										<p class="mt-1 text-xs ui-muted"><%= new Date(ev.created_at).toLocaleString('tr-TR', { timeZone: 'Europe/Istanbul' }) %><% if (ev.changed_by_admin_name) { %> • <%= ev.changed_by_admin_name %><% } %></p>
									</div>
								<% }) %>
							<% } else if (String(order.payment_status || '').toLowerCase() === 'refunded') { %>
								<div class="border ui-border rounded-xl p-3">
									<p class="font-semibold">İade Edildi</p>
										<p class="mt-1 text-xs ui-muted"><%= order.refunded_at ? new Date(order.refunded_at).toLocaleString('tr-TR', { timeZone: 'Europe/Istanbul' }) : (order.created_at ? new Date(order.created_at).toLocaleString('tr-TR', { timeZone: 'Europe/Istanbul' }) : '—') %></p>
								</div>
							<% } else { %>
								<p class="ui-muted text-sm">Henüz ödeme geçmişi yok.</p>
							<% } %>
						</div>
					</div>

					<div class="mt-6">
						<h3 class="text-sm font-semibold">Sipariş Durumu Geçmişi</h3>
						<div class="mt-3 grid gap-3">
							<% if (hasOrderEvents) { %>
								<% order.events.forEach((ev) => { %>
									<div class="border ui-border rounded-xl p-3">
										<p class="font-semibold"><%= (typeof orderStageLabelTR === 'function' ? orderStageLabelTR(ev.status) : statusLabelTR(ev.status)) %></p>
										<p class="mt-1 text-xs ui-muted"><%= new Date(ev.created_at).toLocaleString('tr-TR', { timeZone: 'Europe/Istanbul' }) %><% if (ev.changed_by_admin_name) { %> • <%= ev.changed_by_admin_name %><% } %></p>
									</div>
								<% }) %>
							<% } else { %>
								<p class="ui-muted text-sm">Henüz sipariş durum geçmişi yok.</p>
							<% } %>
						</div>
					</div>
				</div>
			</div>
		<% } %>
	</div>
</section>

<script src="/public/js/shop-track.js" defer></script>
